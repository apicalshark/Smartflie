name: Build

on:
  workflow_dispatch: # allows manual triggering

  push:
    tags:
      - "v[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "V[0-9]+.[0-9]+"
      - "V[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

env:
  QT_VERSION: "6.10.1"
  DIRECTORY: "SmartFileOrganizer"

jobs:
  dist:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        build: [linux_x64, macos_arm64, windows_x64]
        include:
          - build: linux_x64
            os: ubuntu-latest
            arch: x86_64
          - build: macos_arm64
            os: macos-latest
            arch: aarch64
          - build: windows_x64
            os: windows-latest

    steps:
      - name: Install Build Dependencies
        shell: bash
        run: |
          if [[ ${{ matrix.build }} == "macos_arm64" ]]; then
            brew upgrade
            brew install qt vulkan-headers
            # build macdeployqt
            cd ~
            git clone https://github.com/GDATASoftwareAG/macdeployqt
            mkdir -p macdeployqt/build && cd macdeployqt/build
            cmake -GNinja -S .. -DCMAKE_BUILD_TYPE=Release
            cmake --build .
            cp macdeployqt /usr/local/bin/macdeployqt
            cp macdeployqt /usr/local/bin/macdeployqt6
          elif [[ ${{ matrix.build }} == "windows_x64" ]]; then
            choco install zip
          elif [[ ${{ matrix.build }} == "linux_x64" ]]; then
            sudo apt update -y
            sudo apt install -y ninja-build cmake wget qt6-base-dev qt6-wayland libfuse2 \
              build-essential mesa-vulkan-drivers glslang-tools glslc libvulkan-dev libssl-dev \
              libwayland-client0 libwayland-egl1 libwayland-cursor0 libxkbcommon-dev
          fi

      - if: ${{ matrix.os == 'ubuntu-latest' }}
        name: Install AppImage tools
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${{ matrix.arch }}.AppImage
          sudo mv linuxdeploy-${{ matrix.arch }}.AppImage /usr/local/bin/linuxdeploy
          sudo chmod +x /usr/local/bin/linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-${{ matrix.arch }}.AppImage 
          sudo mv linuxdeploy-plugin-qt-${{ matrix.arch }}.AppImage /usr/local/bin/linuxdeploy-plugin-qt
          sudo chmod +x /usr/local/bin/linuxdeploy-plugin-qt
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-${{ matrix.arch }}.AppImage
          sudo mv appimagetool-${{ matrix.arch }}.AppImage /usr/local/bin/appimagetool
          sudo chmod +x /usr/local/bin/appimagetool

      - if: ${{ matrix.os == 'windows-latest' }}
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          arch: win64_mingw

      - name: Checkout
        uses: actions/checkout@v5

      - name: Build release package
        shell: bash
        run: |
          mkdir -p build dist/${{ matrix.build }}
          if [[ ${{ matrix.build }} == "windows_x64" ]]; then
            cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)
            cp -r build/${{ env.DIRECTORY }}.exe build/bin
            zip -r dist/${{ matrix.build }}/${{ env.DIRECTORY }}-${{ matrix.build }}.zip build/bin

          elif [[ ${{ matrix.build }} == "macos_arm64" ]]; then
            cmake -B build -GNinja -DCMAKE_BUILD_TYPE=Release
            ninja -C build
            echo "--- Creating App Bundle Structure ---"
            APP_DIR="${{ env.DIRECTORY }}.app"
            MACOS_DIR="$APP_DIR/Contents/MacOS"
            RESOURCES_DIR="$APP_DIR/Contents/Resources"
            FRAMEWORKS_DIR="$APP_DIR/Contents/Frameworks"
            PLUGINS_DIR="$APP_DIR/Contents/Plugins"

            mkdir -p "$MACOS_DIR" "$RESOURCES_DIR" "$FRAMEWORKS_DIR" "$PLUGINS_DIR"

            # --- 1. Move Your Binaries and Resources ---
            echo "--- Moving Executable and Project Libraries ---"
            mv build/${{ env.DIRECTORY }} "$MACOS_DIR"
            # Your ggml-* files seem like resources, if they are dylibs, move to Frameworks
            mv build/bin/ggml-* "$RESOURCES_DIR" 
            # Assuming these are your own dynamic libraries (e.g., libllama.dylib)
            mv build/bin/*.dylib "$FRAMEWORKS_DIR"
            cp assets/MacOS/Info.plist "$APP_DIR/Contents/Info.plist"

            # --- 2. Add RPATH to Your Executable ---
            # This tells your app to look for libraries in the Frameworks directory.
            echo "--- Adding RPATH to Executable ---"
            install_name_tool -add_rpath @executable_path/../Frameworks "$MACOS_DIR/${{ env.DIRECTORY }}"

            # --- 3. Find, Copy, and Fix Qt Dependencies ---
            echo "--- Bundling Dependencies ---"
            # Use otool to find all linked dynamic libraries and copy them
            # Grep for your homebrew path, or any non-system path like /opt/homebrew or /usr/local
            otool -L "$MACOS_DIR/${{ env.DIRECTORY }}" | grep -E '(/opt/homebrew|/usr/local)' | awk '{print $1}' | while read LIB_PATH; do
                LIB_NAME=$(basename "$LIB_PATH")
    
                # Check if it's a Qt Framework
                if [[ "$LIB_PATH" == *.framework* ]]; then
                    FRAMEWORK_NAME=$(echo "$LIB_PATH" | sed -E 's|.*(/(Qt[^/]+\.framework)).*|\1|')
                    FRAMEWORK_PATH=$(dirname "$LIB_PATH" | sed -E 's|(/Versions/A).*|\1|')
        
                    echo "Copying framework: $FRAMEWORK_NAME"
                    # Copy the entire framework directory
                    cp -R "$FRAMEWORK_PATH" "$FRAMEWORKS_DIR/"
        
                    # Change the executable's reference to this framework
                    NEW_FW_PATH="@rpath/$FRAMEWORK_NAME/Versions/A/$(basename $FRAMEWORK_NAME .framework)"
                    echo "  Fixing executable reference to -> $NEW_FW_PATH"
                    install_name_tool -change "$LIB_PATH" "$NEW_FW_PATH" "$MACOS_DIR/${{ env.DIRECTORY }}"

                else # It's a plain dylib
                    echo "Copying library: $LIB_NAME"
                    cp "$LIB_PATH" "$FRAMEWORKS_DIR/"
        
                    # Change the executable's reference to this library
                    NEW_LIB_PATH="@rpath/$LIB_NAME"
                    echo "  Fixing executable reference to -> $NEW_LIB_PATH"
                    install_name_tool -change "$LIB_PATH" "$NEW_LIB_PATH" "$MACOS_DIR/${{ env.DIRECTORY }}"
                fi
            done

            # --- 4. Fix Linkages INSIDE the Bundled Libraries ---
            echo "--- Recursively Fixing Library Linkages ---"
            find "$FRAMEWORKS_DIR" -type f \( -name "*.dylib" -o -perm +111 \) | while read BUNDLED_LIB; do
                # Only process files that are Mach-O binaries
                if ! file "$BUNDLED_LIB" | grep -q "Mach-O"; then
                    continue
                fi
    
                LIB_BASENAME=$(basename "$BUNDLED_LIB")

                # A. Update the library's own ID so it knows its new @rpath location
                # Frameworks need special handling for their ID
                if [[ "$BUNDLED_LIB" == *.framework* ]]; then
                    FRAMEWORK_NAME=$(echo "$BUNDLED_LIB" | sed -E 's|.*(/(Qt[^/]+\.framework)).*|\1|')
                    NEW_ID="@rpath/$FRAMEWORK_NAME/Versions/A/$(basename $FRAMEWORK_NAME .framework)"
                    echo "Updating ID for $LIB_BASENAME -> $NEW_ID"
                    install_name_tool -id "$NEW_ID" "$BUNDLED_LIB"
                else # Plain dylib
                    NEW_ID="@rpath/$LIB_BASENAME"
                    echo "Updating ID for $LIB_BASENAME -> $NEW_ID"
                    install_name_tool -id "$NEW_ID" "$BUNDLED_LIB"
                fi
    
                # B. Find ITS dependencies and update their paths to point inside the bundle
                otool -L "$BUNDLED_LIB" | grep -E '(/opt/homebrew|/usr/local)' | awk '{print $1}' | while read DEP_PATH; do
                    DEP_NAME=$(basename "$DEP_PATH")
        
                    if [[ "$DEP_PATH" == *.framework* ]]; then
                         DEP_FRAMEWORK_NAME=$(echo "$DEP_PATH" | sed -E 's|.*(/(Qt[^/]+\.framework)).*|\1|')
                         NEW_DEP_PATH="@rpath/$DEP_FRAMEWORK_NAME/Versions/A/$(basename $DEP_FRAMEWORK_NAME .framework)"
                    else
                         NEW_DEP_PATH="@rpath/$DEP_NAME"
                    fi
        
                    echo "  Updating dependency for $LIB_BASENAME: $DEP_NAME -> $NEW_DEP_PATH"
                    install_name_tool -change "$DEP_PATH" "$NEW_DEP_PATH" "$BUNDLED_LIB"
                done
            done

            # --- 5. Copy Essential Qt Plugins ---
            echo "--- Copying Qt Platform Plugin ---"
            QT_PLUGIN_PATH=$(brew --prefix qt)/plugins
            mkdir -p "$PLUGINS_DIR/platforms"
            # Add other plugins (imageformats, etc.) if needed
            cp "$QT_PLUGIN_PATH/platforms/libqcocoa.dylib" "$PLUGINS_DIR/platforms/"
            # Fix the plugin's own dependencies
            install_name_tool -change /opt/homebrew/opt/qtbase/lib/QtCore.framework/Versions/A/QtCore @rpath/QtCore.framework/Versions/A/QtCore "$PLUGINS_DIR/platforms/libqcocoa.dylib"
            install_name_tool -change /opt/homebrew/opt/qtbase/lib/QtGui.framework/Versions/A/QtGui @rpath/QtGui.framework/Versions/A/QtGui "$PLUGINS_DIR/platforms/libqcocoa.dylib"
            install_name_tool -change /opt/homebrew/opt/qtbase/lib/QtWidgets.framework/Versions/A/QtWidgets @rpath/QtWidgets.framework/Versions/A/QtWidgets "$PLUGINS_DIR/platforms/libqcocoa.dylib"

            sips -s format icns "assets/icon/icon.png" --out "$RESOURCES_DIR/icon.icns"
            hdiutil create -volname "${{ env.DIRECTORY }}" -srcfolder "$APP_DIR" -ov -format UDZO "dist/${{ matrix.build }}/${{ env.DIRECTORY }}-${{ matrix.build }}.dmg"
          elif [[ ${{ matrix.build }} == "linux_x64" ]]; then
            cmake -B build -GNinja -DCMAKE_BUILD_TYPE=Release \
              -DGGML_VULKAN=OFF \
              -DCMAKE_C_FLAGS="$CFLAGS -march=x86-64-v3 -O3" -DCMAKE_CXX_FLAGS="$CXXFLAGS -march=x86-64-v3 -O3"
            ninja -C build
            mkdir -p ${{ env.DIRECTORY }} AppDir/usr/bin AppDir/usr/lib64 AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/512x512/apps
            cp -r build/bin/* ${{ env.DIRECTORY }}/
            cp build/${{ env.DIRECTORY }} ${{ env.DIRECTORY }}/
            tar -czvf ${{ env.DIRECTORY }}-${{ matrix.build }}.tar.gz ${{ env.DIRECTORY }}
            cp ${{ env.DIRECTORY }}-${{ matrix.build }}.tar.gz dist/${{ matrix.build }}

            cp -r build/bin/* AppDir/usr/lib64
            cp build/${{ env.DIRECTORY }} AppDir/usr/bin
            cp assets/linux/${{ env.DIRECTORY }}.desktop AppDir/usr/share/applications
            cp assets/icon/icon.png AppDir/usr/share/icons/hicolor/512x512/apps/icon.png

            export EXTRA_PLATFORM_PLUGINS="libqwayland-generic.so;libqwayland-egl.so"
            export EXTRA_QT_MODULES="waylandcompositor"
            linuxdeploy --plugin=qt --appdir AppDir

            if [ "${{ matrix.arch }}" == "x86_64" ]; then
              ARCH=x86_64 appimagetool AppDir ${{ env.DIRECTORY }}-${{ matrix.build }}.AppImage
            else
              ARCH=arm_aarch64 appimagetool AppDir ${{ env.DIRECTORY }}-${{ matrix.build }}.AppImage
            fi
            mv ${{ env.DIRECTORY }}-${{ matrix.build }}.AppImage dist/${{ matrix.build }}
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.build }}
          path: |
            dist/${{ matrix.build }}

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [dist]
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v4

      - name: Calculate tag name
        run: |
          name=dev
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            name=${GITHUB_REF:10}
          fi
          echo val=$name >> $GITHUB_OUTPUT
          echo TAG=$name >> $GITHUB_ENV
        id: tagname

      - name: Build archive
        run: |
          set -ex

          rm -rf tmp
          mkdir tmp
          mkdir dist

          for dir in artifact*; do
            platform=${dir#"artifact-"}
            unset exe
            if [[ $platform =~ "windows" ]]; then
              cp $dir/${{ env.DIRECTORY }}-${platform}.zip dist
            elif [[ $platform =~ "macos" ]]; then
              cp $dir/${{ env.DIRECTORY }}-${platform}.dmg dist
            elif [[ $platform =~ "linux" ]]; then
              cp $dir/${{ env.DIRECTORY }}-${platform}.AppImage dist
              cp $dir/${{ env.DIRECTORY }}-${platform}.tar.gz dist
            fi
          done

      - name: Upload as artifact
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: dist/*

      - name: Upload binaries to release
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/*
          file_glob: true
          tag: ${{ steps.tagname.outputs.val }}
          overwrite: true

      - name: Extract version
        id: extract-version
        run: |
          printf "%s=%s\n" >> $GITHUB_OUTPUT tag-name "${GITHUB_REF#refs/tags/}"
